# PYMECompress 文件详解

## 根目录文件

### setup.py
**作用**: 项目主安装脚本  
**功能**:
- 使用NumPy distutils进行构建
- 配置子包pymecompress的编译
- 处理Cython代码编译
- 设置项目元数据（作者、版本、许可证等）
- 包含build_src的猴子补丁以生成分发头文件

**使用方法**:
```bash
# 开发模式安装
python setup.py develop

# 正式安装
python setup.py install

# Windows构建
python setup.py build --compiler=mingw32
python setup.py install
```

### pyproject.toml
**作用**: 现代Python项目配置文件（PEP 518）  
**功能**:
- 定义构建后端为meson-python
- 指定构建依赖：meson-python、numpy、cython
- 包含项目元数据：版本0.3.6、作者信息、项目URL

**相关标准**: PEP 517/518

### requirements.txt
**作用**: 项目依赖列表  
**内容**:
- numpy >=1.11
- cython
- six

**使用方法**:
```bash
pip install -r requirements.txt
```

### meson.build
**作用**: Meson构建系统配置（根级别）  
**功能**:
- 定义项目名称、语言（C、Cython）
- 设置BSD-3许可证
- 指向子目录pymecompress的构建配置

### MANIFEST.in
**作用**: 源码分发时包含的额外文件清单  
**内容**:
- README.md（项目说明）
- LICENSE（许可证）
- pymecompress/*.pyx（Cython源码）

### LICENSE
**作用**: BSD 3-Clause许可证文件  
**版权**: David Baddeley, 2019  
**许可类型**: BSD-3（允许商业使用，需保留版权声明）

### README.md
**作用**: 项目说明文档  
**内容**:
- 项目介绍和特性
- 安装指南（conda、pip、源码）
- 使用示例（numcodecs、Zarr、直接调用）
- 性能指标

### .gitignore
**作用**: Git版本控制忽略配置  
**忽略内容**:
- Python编译文件（__pycache__、*.pyc）
- C扩展（*.so）
- 构建产物（build/、dist/、*.egg-info）
- 自动生成的分发文件（quantize.dispatch.*）
- 测试数据和结果

### test_pymecompress.py
**作用**: pytest单元测试套件  
**测试用例**:
1. `test_compression_lossless_uint16()`: 测试uint16数据的无损压缩
2. `test_compression_lossless_uint8()`: 测试uint8数据的无损压缩
3. `test_loss_within_sigma()`: 验证量化损失在泊松噪声范围内

**运行方法**:
```bash
pytest test_pymecompress.py
pytest --cov pymecompress  # 带覆盖率
```

### azure-pipelines.yml
**作用**: Azure DevOps CI/CD流水线配置  
**功能**:
- 多平台测试：Ubuntu、macOS、Windows
- 多Python版本：2.7、3.6（已过时）
- Windows特殊处理：使用conda、mingw编译器
- 自动运行pytest

**触发**: master分支提交

### libpython27.a
**作用**: Windows平台Python 2.7静态链接库  
**用途**: MinGW编译时链接使用（历史遗留）

### mingw_native.ini
**作用**: MinGW交叉编译配置文件  
**用途**: 配置Windows平台的GCC编译器选项

### setup.cfg.win
**作用**: Windows特定的setuptools配置  
**用途**: 指定Windows构建时的特殊选项

## pymecompress/ 目录文件

### pymecompress/__init__.py
**作用**: 包初始化文件，定义公开API  
**导出内容**:
- `version` - 版本模块
- `HuffmanCompress` - 霍夫曼压缩函数
- `HuffmanCompressQuant` - 带量化的霍夫曼压缩
- `HuffmanDecompress` - 霍夫曼解压函数

**使用示例**:
```python
import pymecompress
compressed = pymecompress.HuffmanCompress(data)
```

### pymecompress/version.py
**作用**: 版本信息文件  
**内容**: `version='0.3.6'`  
**用途**: setup.py和__init__.py读取版本号

### pymecompress/bcl.pyx
**作用**: Cython包装器，连接Python和C代码  
**主要函数**:
1. `HuffmanCompress(data)`: 压缩uint8数据
2. `huffman_compress_buffer(data)`: 返回bytes的压缩
3. `huffman_compress_quant_buffer(data, offset, scale)`: 带量化压缩
4. `HuffmanCompressQuant(data, offset, scale)`: 量化+压缩uint16数据
5. `HuffmanDecompress(data, outsize)`: 解压缩
6. `huffman_decompress_buffer(data, out)`: 解压到缓冲区

**技术要点**:
- 使用Cython的内存视图（memoryview）提高性能
- 调用C函数：Huffman_Compress、quantize_u16
- 自动内存管理

### pymecompress/codecs.py
**作用**: numcodecs兼容的编解码器实现  
**类**:
1. **Huffman**: 无损霍夫曼编解码器
   - codec_id: 'pymecompress-huffman'
   - 输入类型: uint8
   - 完全无损

2. **HuffmanQuant16**: 带量化的霍夫曼编解码器
   - codec_id: 'pymecompress-quant16'
   - 输入类型: uint16
   - 参数: offset（偏移）、scale（缩放）
   - 量化公式: `quantized = sqrt((data - offset) / scale)`
   - 反量化: `dequantized = quantized^2 * scale + offset`

**使用示例**:
```python
from pymecompress import codecs
import zarr

# 与Zarr集成
z = zarr.zeros(1000000, dtype='uint16', 
               compressor=codecs.HuffmanQuant16(offset=0, scale=1))
```

### pymecompress/quantize.h
**作用**: 量化函数的C头文件  
**函数声明**:
- `quantize_u16(...)`: 主量化函数（自动选择实现）
- `quantize_u16_noavx(...)`: 非AVX版本（兼容性）
- `quantize_u16_avx(...)`: AVX优化版本（高性能）

**参数**:
- `data`: 输入uint16数组
- `out`: 输出uint8数组
- `size`: 数组大小
- `offset`: 量化偏移
- `scale`: 量化缩放因子

### pymecompress/quantize.c
**作用**: 量化算法的C实现  
**功能**:
- 将uint16图像量化为uint8
- 公式: `out = sqrt((data - offset) / scale)`
- 保持量化误差在泊松噪声范围内
- 使用AVX指令并行处理8个像素

**技术细节**:
- 使用`__m256`向量类型
- `_mm256_load_ps`加载数据
- `_mm256_sqrt_ps`向量开方
- 自动向下取整到uint8

### pymecompress/quantize.dispatch.c
**作用**: CPU特性检测和函数分发  
**功能**:
- 运行时检测CPU是否支持AVX
- 自动选择最优实现（AVX或标准版本）
- 提供统一接口`quantize_u16`

### pymecompress/cython_numpy_monkey.py
**作用**: NumPy构建系统猴子补丁  
**功能**:
- 用Cython替换Pyrex
- 修复`build_src.generate_a_pyrex_source`方法
- 处理Cython编译选项

**历史**: Pyrex是Cython的前身，现已废弃

### pymecompress/setup.py
**作用**: 子包构建配置脚本  
**功能**:
- 配置bcl扩展模块编译
- 处理平台差异（Windows/Linux/macOS）
- MinGW特殊处理和多个猴子补丁
- 预编译Cython文件

**编译选项**:
- `-O3`: 最高优化级别
- `-fno-exceptions`: 禁用异常（C代码）
- `-ffast-math`: 快速数学运算

**Windows特殊处理**:
- 查找objdump、dlltool
- 构建导入库
- 静态链接libgcc

### pymecompress/meson.build
**作用**: Meson子包构建配置  
**功能**:
- 配置bcl扩展模块
- 源文件：bcl.pyx、bcl/huffman.c、quantize.c
- 包含NumPy头文件
- 安装Python源文件：__init__.py、version.py、codecs.py

## pymecompress/bcl/ 目录文件

### bcl/huffman.c 和 huffman.h
**作用**: 优化的霍夫曼编码实现  
**功能**:
- 构建霍夫曼树
- 生成编码表
- 快速编码/解码
- 内存高效

**来源**: 修改自Basic Compression Library (BCL)

### bcl/lz.c、rice.c、rle.c、shannonfano.c
**作用**: BCL其他压缩算法（未使用）  
**说明**: 这些是BCL库的一部分，但pymecompress仅使用霍夫曼编码

### bcl/systimer.c/h
**作用**: 系统计时器工具  
**用途**: 性能测试和基准测试

### bcl/bcltest.c
**作用**: BCL库的测试程序  
**用途**: 独立测试压缩算法

### bcl/bfc.c
**作用**: BCL文件压缩器示例  
**用途**: 命令行压缩工具演示

### bcl/Makefile
**作用**: BCL库的Make构建脚本  
**用途**: 独立编译BCL工具（非主构建流程）

### bcl/doc/manual.pdf
**作用**: BCL原始文档  
**内容**: Basic Compression Library使用手册和许可证

## pymecompress/win_incl/ 目录文件

### win_incl/stdint.h 和 inttypes.h
**作用**: Windows C标准库兼容头文件  
**原因**: 旧版Visual C++不完全支持C99标准  
**来源**: msinttypes项目（https://code.google.com/archive/p/msinttypes）  
**用途**: 提供int8_t、uint16_t等类型定义

## test_data/ 目录

### 13um_1_im_561_005_002.mat
**作用**: MATLAB格式测试数据文件  
**用途**: 真实显微镜图像数据，用于测试压缩性能  
**说明**: .gitignore中排除test_data/，不会提交到仓库

